<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd"> 

<mapper namespace="com.vinflux.mobile.ems.user">
	<parameterMap id="parameterMap" type="java.util.HashMap" />
 	<resultMap id="resultMap" type="java.util.HashMap" />


	<insert id="InsertUserInfo" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO  TSE_MST_MEM 
			(
			  MBRBARCODE
			, CTKEY
			, EMAIL
			, PWD
			, MBRNAME
			, NICKNAME
			, JOINDATE
			, JOINTYPE
			, DEVICEID
			, DEVICE_TYPE
			, OS_VER
			, PUSH_ID
			, AUTH_TYPE
			, AUTH_KEY
			, IMGID
			, INSERTDATE
			, UPDATEDATE
			)
		    VALUES
		    (
		      #{MBRBARCODE}
		    , #{CTKEY}
		    , #{EMAIL}
		    , #{PWD}
		    , #{MBRNAME}
		    , #{NICKNAME}
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    , #{JOINTYPE}
		    , #{DEVICEID}
		    , #{DEVICE_TYPE}
			, #{OS_VER}
			, #{PUSH_ID}
			, #{AUTH_TYPE}
			, #{AUTH_KEY}
			, #{FILEID}
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    )	
		]]>		
	</insert>
	
	<update id="UpdateUserInfo" parameterMap="parameterMap">
		<![CDATA[
			UPDATE TSE_MST_MEM
			   SET UPDATEDATE = to_char(current_timestamp,'YYYYMMDDHH24MISS')
		]]>	
		<if test="DEVICEID != null and DEVICEID != ''">
			<![CDATA[
				 , DEVICEID = #{DEVICEID}
			]]>	
		</if>
		
		<if test="PUSH_ID != null and PUSH_ID != ''">
			<![CDATA[
				 , PUSH_ID = #{PUSH_ID}
			]]>	
		</if>
				 
		<if test="EMAIL != null">
			<![CDATA[
				, EMAIL = #{EMAIL}
				 
			]]>	
		</if>
	
		<if test="PWD != null">
			<![CDATA[
				, PWD = #{PWD}
				 
			]]>	
		</if>
		
		<if test="NICKNAME != null">
			<![CDATA[
				, NICKNAME = #{NICKNAME}
				 
			]]>	
		</if>

		<if test="STATUS_CONTENTS != null">
			<![CDATA[
				, STATUS_CONTENTS = #{STATUS_CONTENTS}
				 
			]]>	
		</if>

		<if test="GENDER != null">
			<![CDATA[
				, GENDER = #{GENDER}
				 
			]]>	
		</if>

		<if test="BIRTHDAY != null">
			<![CDATA[
				, BIRTHDAY = #{BIRTHDAY}
				 
			]]>	
		</if>
		
		<if test="MOBILE != null">
			<![CDATA[
				, MOBILE = #{MOBILE}
			]]>	
		</if>

		<if test="TEL != null">
			<![CDATA[
				, TEL = #{TEL}
			]]>	
		</if>

				
		<if test="ZIPCODE != null">
			<![CDATA[
				, ZIPCODE = #{ZIPCODE}
			]]>	
		</if>
		
		<if test="ADDRESS1 != null">
			<![CDATA[
				, ADDRESS1 = #{ADDRESS1}
			]]>	
		</if>
		
		<if test="ADDRESS2 != null">
			<![CDATA[
				, ADDRESS2 = #{ADDRESS2}
			]]>	
		</if>		
						
		<![CDATA[
			 WHERE MBRBARCODE = #{MBRBARCODE}
		]]>	
	</update>

	<select id="SelectUserInfo" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
			SELECT A.MBRBARCODE
				 , A.CTKEY
				 , A.EMAIL
				 , A.MBRNAME
 				 , A.NICKNAME
				 , A.GENDER
				 , A.BIRTHDAY
				 , A.MOBILE
				 , A.TEL
				 , A.JOINDATE
				 , A.LEAVEDATE
				 , A.ADDRESS1
				 , A.ADDRESS2
				 , A.COUNTRYCODE
				 , A.CITY
				 , A.STATE
				 , A.ZIPCODE
				 , A.MBRLEVEL
				 , A.JOINTYPE
				 , A.DEVICEID
				 , A.SAVMONEY
				 , A.PRESAVMONEY
				 , A.SELFINTRO
				 , A.MYHOMEID
				 , A.MAILRECEIVE
				 , A.DEVICE_TYPE
				 , A.OS_VER
				 , A.PUSH_ID
				 , A.AUTH_TYPE
				 , A.AUTH_KEY
				 , A.STATUS_CONTENTS
				 , A.IMGID
			 	 , NVL(
			        (SELECT B.IMGURL
			           FROM TSE_INFO_IMG B
			          WHERE A.IMGID = B.FILEID), 'NONE') AS IMGPATH   
	 	]]>	   
		<!-- Get User Info for EMAIL Auth -->
		<if test="EMAIL != null and EMAIL != '' ">
			<![CDATA[
				 , A.PWD
			]]>	
		</if>	 	
	 	<![CDATA[ 
			  FROM TSE_MST_MEM  A
		]]>	
		<!-- Get User Info After Insert User Info -->

		<!-- Get User Info for SNS Auth -->
		<if test="AUTH_KEY != null and AUTH_KEY != ''">
			<![CDATA[
				WHERE AUTH_KEY = #{AUTH_KEY}
			]]>	
		</if>
		<!-- Get User Info for EMAIL Auth -->
		<if test="EMAIL != null and EMAIL != '' ">
			<![CDATA[
				WHERE EMAIL = #{EMAIL}
			]]>	
		</if>
		<if test="MBRBARCODE != null and DEVICEID != null">
			<![CDATA[
				WHERE DEVICEID   = #{DEVICEID}
				AND MBRBARCODE = #{MBRBARCODE}
			]]>	
		</if>
		<if test="MBRBARCODE != null and DEVICEID == null">
			<![CDATA[
				WHERE MBRBARCODE = #{MBRBARCODE}
			]]>	
		</if>
	</select>
		
		
		
		
		
		
	<select id="SelectMyDetailInfo" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
			SELECT A.MBRBARCODE
				 , A.CTKEY
				 , A.EMAIL
				 , A.MBRNAME
 				 , A.NICKNAME
				 , A.GENDER
				 , A.BIRTHDAY
				 , A.MOBILE
				 , A.TEL
				 , A.JOINDATE
				 , A.LEAVEDATE
				 , A.ADDRESS1
				 , A.ADDRESS2
				 , A.COUNTRYCODE
				 , A.CITY
				 , A.STATE
				 , A.ZIPCODE
				 , A.MBRLEVEL
				 , A.JOINTYPE
				 , A.DEVICEID
				 , A.SAVMONEY
				 , A.PRESAVMONEY
				 , A.SELFINTRO
				 , A.MYHOMEID
				 , A.MAILRECEIVE
				 , A.DEVICE_TYPE
				 , A.OS_VER
				 , A.PUSH_ID
				 , A.AUTH_TYPE
				 , A.AUTH_KEY
				 , A.STATUS_CONTENTS
				 , A.IMGID
			  	 , NVL(
			        (SELECT B.IMGURL
			           FROM TSE_INFO_IMG B
			          WHERE A.IMGID = B.FILEID), 'NONE') AS IMGPATH  
	      		 
	      		 , (SELECT COUNT(C.FOLLOWID) 
					  FROM TSE_INFO_FL  C
					 WHERE C.MBRBARCODE = #{MBRBARCODE}
				   ) AS FOLLLOWERCOUNT
	      		 
	      		 , (SELECT COUNT(D.SCRAPID) 
					  FROM TSE_INFO_LI  D
					 WHERE D.ISDISPLAY = 'Y'
					   AND D.MYHOMEID = #{MBRBARCODE}
				   ) AS LIKECOUNT
				   
	        	 , (SELECT COUNT(E.SCRAPID) 
					  FROM TSE_INFO_SRP  E
					 WHERE E.ISDISPLAY = 'Y'
					   AND E.MYHOMEID = #{MBRBARCODE}
				   ) AS FEEDCOUNT
				    
			  FROM TSE_MST_MEM  A
			 WHERE A.CTKEY    = #{CTKEY}
		  	   AND A.MBRBARCODE = #{MBRBARCODE}
			]]>	
	</select>
	
	
	
	
	<select id="CheckDeviceInfo" parameterMap="parameterMap" resultType="java.lang.Integer">
		<![CDATA[
			SELECT COUNT(*)
			  FROM TSE_MST_MEM
			 WHERE DEVICEID = #{DEVICEID}
			   AND CTKEY    = #{CTKEY}
		]]>		
	</select>
	
	
	<insert id="InsertUserServiceInfo" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO TSE_MST_SVC 
			(
			  MBRBARCODE
			, SVC_ID
			, AGREE_YN
			, USE_YN
			, INSERTDATE
			, UPDATEDATE
			)
		    VALUES
		    (
		      #{MBRBARCODE}
		    , #{SVC_ID}
		    , #{AGREE_YN}
		    , #{USE_YN}
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    )	
		]]>		
	</insert>
	
	<update id="UpdateUserServiceInfo" parameterMap="parameterMap">
		
		<![CDATA[
			UPDATE TSE_MST_SVC
			   SET UPDATEDATE = to_char(current_timestamp,'YYYYMMDDHH24MISS')
		]]>	
		
		<if test="AGREE_YN != null">
			<![CDATA[
				 , AGREE_YN = #{AGREE_YN}
			]]>	
		</if>
		
		<if test="USE_YN != null">
			<![CDATA[
				 , USE_YN = #{USE_YN}
			]]>	
		</if>
		
		<![CDATA[
			 WHERE MBRBARCODE = #{MBRBARCODE}
			   AND SVC_ID     = #{SVC_ID}
		]]>	
		
	</update>	
	
	
	<select id="SelectUserServiceInfo" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
			SELECT MBRBARCODE
				 , SVC_ID
				 , AGREE_YN
				 , USE_YN
				 , INSERTDATE
				 , UPDATEDATE
	 		  FROM TSE_MST_SVC
			 WHERE MBRBARCODE = #{MBRBARCODE}
		]]>	
	</select>







	
	<select id="SelectFollowUserInfoList" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
			SELECT E.*
			  FROM (
			  SELECT ROWNUM AS ROWNO, D.* 
			    FROM (  -- 제품정보 헤더  
						SELECT A.CTKEY
						     , A.MBRBARCODE
							 , A.EMAIL
							 , A.MBRNAME
							 , A.NICKNAME
							 , NVL(A.STATUS_CONTENTS, 'NONE') AS STATUS_CONTENTS
							 , NVL(
						        (SELECT B.IMGURL
						           FROM TSE_INFO_IMG B
						          WHERE A.IMGID = B.FILEID), 'NONE') AS IMGPATH  
							 
							 , (SELECT COUNT(C.FOLLOWID) 
								  FROM TSE_INFO_FL  C
								 WHERE C.MBRBARCODE = #{MBRBARCODE}
							   ) AS FOLLLOWERCOUNT
				      		 
				      		 , (SELECT COUNT(D.SCRAPID) 
								  FROM TSE_INFO_LI  D
								 WHERE D.ISDISPLAY = 'Y'
								   AND D.MYHOMEID = #{MBRBARCODE}
							   ) AS LIKECOUNT
							   
				        	 , (SELECT COUNT(E.SCRAPID) 
								  FROM TSE_INFO_SRP  E
								 WHERE E.ISDISPLAY = 'Y'
								   AND E.MYHOMEID = #{MBRBARCODE}
							   ) AS FEEDCOUNT
							   
					 	  FROM TSE_MST_MEM  A
						     , TSE_INFO_FL  C
						 WHERE C.FOLLOWID   = A.MBRBARCODE
				 		   AND C.MBRBARCODE = #{MBRBARCODE}
  	 			           AND C.CTKEY      = #{CTKEY}
	   			  	     ORDER BY A.INSERTDATE DESC
		         	) D
			   WHERE ROWNUM <= #{LAST_INDEX}
			   ORDER BY ROWNUM ASC
			   ) E
			 WHERE E.ROWNO >= #{START_INDEX}  
		]]>	
 			   
	</select>
	
	
	
	<select id="SelectFollowUserInfo" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
		
			SELECT A.CTKEY
			     , A.MBRBARCODE
				 , A.EMAIL
				 , A.MBRNAME
 				 , A.NICKNAME
				 , NVL(A.STATUS_CONTENTS, 'NONE') AS STATUS_CONTENTS
				 , NVL(
			        (SELECT B.IMGURL
			           FROM TSE_INFO_IMG B
			          WHERE A.IMGID = B.FILEID), 'NONE') AS IMGPATH 
						          
 				 , (SELECT COUNT(D.FOLLOWID) 
				      FROM TSE_INFO_FL  D
				     WHERE D.FOLLOWID   = #{FOLLOWID}
				       AND D.MBRBARCODE = #{MBRBARCODE}
				       AND D.ISDISPLAY = 'Y'
				    ) AS ISFOLLOW 
				
				 , (SELECT COUNT(C.FOLLOWID) 
					  FROM TSE_INFO_FL  C
					 WHERE C.MBRBARCODE = #{MBRBARCODE}
				   ) AS FOLLLOWERCOUNT
	      		 
	      		 , (SELECT COUNT(D.SCRAPID) 
					  FROM TSE_INFO_LI  D
					 WHERE D.ISDISPLAY = 'Y'
					   AND D.MYHOMEID = #{MBRBARCODE}
				   ) AS LIKECOUNT
				   
	        	 , (SELECT COUNT(E.SCRAPID) 
					  FROM TSE_INFO_SRP  E
					 WHERE E.ISDISPLAY = 'Y'
					   AND E.MYHOMEID = #{MBRBARCODE}
				   ) AS FEEDCOUNT
				     
   			  FROM TSE_MST_MEM  A
			 WHERE A.CTKEY      = #{CTKEY}
  			   AND A.MBRBARCODE = #{FOLLOWID}
			]]>	

	</select>
	
	
	
	<insert id="InsertFollowUserInfo" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO TSE_INFO_FL 
			(
			  CTKEY
			, FOLLOWID
			, MBRBARCODE
			, ISDISPLAY
			, INSERTDATE
			, UPDATEDATE
			)
		    VALUES
		    (
		      #{CTKEY}
		    , #{FOLLOWID}
		    , #{MBRBARCODE}
		    , 'Y'
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    )	
		]]>		
	</insert>
	
	
	<update id="UpdateFollowUserInfo" parameterMap="parameterMap">
		
		<![CDATA[
			UPDATE TSE_INFO_FL
			   SET ISDISPLAY = 'N'
		     WHERE MBRBARCODE = #{MBRBARCODE}
			   AND FOLLOWID   = #{FOLLOWID}
		       AND CTKEY    = #{CTKEY}
		]]>	
	
	</update>	
	
	<update id="DeleteFollowUserInfo" parameterMap="parameterMap">
		
		<![CDATA[
			DELETE FROM TSE_INFO_FL
		     WHERE MBRBARCODE = #{MBRBARCODE}
			   AND FOLLOWID   = #{FOLLOWID}
			   AND CTKEY    = #{CTKEY}
		]]>	
	
	</update>	
	
	
			
	<update id="UpdateUserPoint" parameterMap="parameterMap">
	
		<![CDATA[
			UPDATE TSE_MST_MEM
			   SET SAVMONEY   = SAVMONEY - to_number(#{PINT_PAYMENT})
		     WHERE MBRBARCODE = #{MBRBARCODE}
		       AND CTKEY    = #{CTKEY}
		]]>	
	
	</update>	

	
	
</mapper>