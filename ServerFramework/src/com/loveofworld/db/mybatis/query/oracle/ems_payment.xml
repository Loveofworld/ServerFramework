<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd"> 

<mapper namespace="com.vinflux.mobile.ems.payment">
	<parameterMap id="parameterMap" type="java.util.HashMap" />
 	<resultMap id="resultMap" type="java.util.HashMap" />
	
	<insert id="InsertOrderHeadInfo" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO TSE_INFO_OR_HD 
			(
			  CTKEY
			, ORHDKEY
			, ORHDDATE
			, MBRBARCODE
			, PAYOPTION
			, ORSTATUS
			, PAYSTATUS
			, PURSTATUS
			, ONOFFKEY
			, INSERTDATE
			, INSERTURKEY
			, UPDATEDATE
			, UPDATEURKEY
			)
			VALUES
			(
			  #{CTKEY}
			, #{ORHDKEY}
			, to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
			, '01'
			, 'OR01'
			, 'PA01'
			, 'PUR01'
			, '01'
			, to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
			, to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
			)	
		]]>		
	</insert>
	
	<insert id="InsertOrderDetailInfo" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO TSE_INFO_OR_DT 
			(
			  CTKEY
			, ORHDKEY
			, ORDTKEY
			, ICKEY
			, ORQTY
			, CFQTY
			, UOM
			, SALESAMT
			, DISAMT
			, PAYAMT
			, TRADEID
			, SENDERBARCODE
			, RECEIVERBARCODE
			, SENDERPREMONEY
			, RECEIVERPREMONEY
			, INSERTDATE
			, INSERTURKEY
			, UPDATEDATE
			, UPDATEURKEY
			)
			VALUES
			(
	
			  #{CTKEY}
			, #{ORHDKEY}
			, #{ORDTKEY}
			, #{ICKEY}
			, #{ORQTY}
			, #{CFQTY}
			, 'EA'
			, #{SALESAMT}
			, #{DISAMT}
			, #{PAYAMT}
			, #{TRADEID}
			, #{SENDERBARCODE}
			, #{RECEIVERBARCODE}
			, #{SENDERPREMONEY}
			, #{RECEIVERPREMONEY}
			, to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
			, to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
			)	
		]]>		
	</insert>
	
			
	<insert id="InsertDeliveryHeadInfo" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO TSE_INFO_DL_HD 
			(
			  CTKEY
			, ORHDKEY
			, DLHDKEY
			, DLVSTATUS
			, DLVTEL
			, DLVMBRNAME
			, DLVADDRESS
			, ORADDRESS2
			, DLVZIPCODE
			, DLVFEE
			, INSERTDATE
			, INSERTURKEY
			, UPDATEDATE
			, UPDATEURKEY
			, DLVMOBILE 
			, DLVEMAIL
			, DLREQUESTEDTERM
			)
			VALUES
			(
  			  #{CTKEY}
			, #{ORHDKEY}
			, #{DLHDKEY}
			, 'DL01'
			, #{DLVTEL}
			, #{DLVMBRNAME}
			, #{DLVADDRESS}
			, #{ORADDRESS2}
			, #{DLVZIPCODE}
			, '0'
			, to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
			, to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
			, #{DLVMOBILE}
			, #{DLVEMAIL}
			, #{DLREQUESTEDTERM}
			)	
		]]>		
	</insert>
	
	
	
	<insert id="InsertDeliveryDetailInfo" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO TSE_INFO_DL_DT 
			(
			  CTKEY
			, ORHDKEY
			, DLHDKEY
			, DLDTKEY
			, ICKEY
			, QTY
			, INSERTDATE
			, INSERTURKEY
			, UPDATEDATE
			, UPDATEURKEY
			)
			VALUES
			(
			  #{CTKEY}
			, #{ORHDKEY}
			, #{DLHDKEY}
			, #{DLDTKEY}
			, #{ICKEY}
			, #{QTY}
			, to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
			, to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
			)	
		]]>		
	</insert>
	
	

		
	<select id="SelectTotalAmtInfo" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
			SELECT SUM(B.SALESAMT) AS TOTALSALESAMT
			     , SUM(B.DISAMT) AS TOTALDISAMT
			     , SUM(B.PAYAMT) AS TOTALPAYAMT
			 FROM TSE_INFO_OR_DT B
			WHERE B.ORHDKEY = #{ORHDKEY}
 		]]>	 
	</select>
	
			
	<select id="SelectUserOrderInfo" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
			SELECT A.ORHDKEY
			     , A.ORHDDATE
			     
			     , A.ORSTATUS
			     , (SELECT B.ADCD_DTNAME
			          FROM ADMIN.TADMIN_MST_ADCD_DT B
			         WHERE B.ADCD_HDKEY   = 'ORSTATUS'
			           AND B.ADCD_DTVALUE = A.ORSTATUS
			           AND B.LAKEY        = 'KOR'
			         ) AS ORSTATUS_DESC
			     
			     , A.PAYSTATUS
			     , (SELECT B.ADCD_DTNAME
			          FROM ADMIN.TADMIN_MST_ADCD_DT B
			         WHERE B.ADCD_HDKEY   = 'PAYSTATUS'
			           AND B.ADCD_DTVALUE = A.PAYSTATUS
			           AND B.LAKEY        = 'KOR'
			         ) AS PAYSTATUS_DESE
			     
			     
			     , A.PURSTATUS AS PURCHASESTATUS
			     , (SELECT B.ADCD_DTNAME
			        FROM ADMIN.TADMIN_MST_ADCD_DT B
			       WHERE B.ADCD_HDKEY   = 'PURSTATUS'
			         AND B.ADCD_DTVALUE = A.PURSTATUS
			         AND B.LAKEY        = 'KOR'
			       ) AS PURSTATUS_DESC
			         
			     , C.DLVSTATUS
			     , (SELECT B.ADCD_DTNAME
			        FROM ADMIN.TADMIN_MST_ADCD_DT B
			       WHERE B.ADCD_HDKEY   = 'DLVSTATUS'
			         AND B.ADCD_DTVALUE = A.DLVSTATUS
			         AND B.LAKEY        = 'KOR'
			       ) AS DLVSTATUS_DESC
			       
			     , A.PG_APRNUM
			     , NVL(A.SALE_TOTALPRICE, '0') AS SALE_TOTALPRICE
			     , NVL(A.PINT_PAYMENT, '0') AS PINT_PAYMENT
			     , NVL(A.PG_TOTALPRICE, '0') AS PG_TOTALPRICE
			       , (SELECT COUNT(B.ORDTKEY)
			            FROM  TSE_INFO_OR_DT B
			           WHERE B.ORHDKEY = A.ORHDKEY) AS QTY 
			           , (SELECT C.ICNAME
			            FROM  TSE_INFO_OR_DT B
			               ,  TWORK_MST_IC_DT C
			           WHERE B.ORHDKEY = A.ORHDKEY
			             AND C.ICKEY   LIKE SUBSTR(B.ICKEY, 1, 8)||'%'
			             AND ROWNUM = 1) AS ORDER_DESC 
			  FROM TSE_INFO_OR_HD A
			     , TSE_INFO_DL_HD C
			 WHERE A.ORHDKEY = C.ORHDKEY
			   AND A.CTKEY   = #{CTKEY}
			   AND A.MBRBARCODE = #{MBRBARCODE}
			 ORDER BY A.ORHDDATE DESC
 		]]>	 
	</select>
	

 	<select id="SelectUserOrderDetailInfo" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
				SELECT DISTINCT
			           A.CTKEY
			         , A.OWKEY
			         , A.RPRICKEY
			         , B.ICNAME
			         , A.BRANDCODE
			         , A.INSERTDATE
			         , C.ICKEY
			         , C.ORQTY
			         , C.CFQTY
			         , C.SALESAMT
			         , C.DISAMT
			         , C.PAYAMT
			         
	  				 , NVL(
				        (SELECT C.IMGURL
				           FROM TWORK_MST_IC_IMG C
				          WHERE C.RPRICKEY = A.RPRICKEY 
				            AND C.IMGSEQ   = '1'), 'NONE') AS MAIN_IMAGE   
				          
				     , NVL(
				         (SELECT SUBSTR(XMLAGG(XMLELEMENT("IMGURL", ','||C.IMGURL) ORDER BY C.IMGURL ).EXTRACT('//text()'), 2) AS IMGURL
				           FROM TWORK_MST_IC_IMG C
				          WHERE C.RPRICKEY = A.RPRICKEY 
				            AND C.IMGSEQ  <> '1'), 'NONE') AS DETAIL_IMAGE   
			            
			      FROM TWORK_MST_IC_HD A
			         , TWORK_MST_IC_DT B
			         , TSE_INFO_OR_DT  C
			     WHERE A.ICKEY   = B.ICKEY
			       AND A.ICKEY   = C.ICKEY
			       AND C.CTKEY   = #{CTKEY}
			       AND C.ORHDKEY = #{ORHDKEY}  
			     ORDER BY A.INSERTDATE DESC
 		]]>	 
	</select>
	

	
	
	<update id="UpdatePaymentInfo" parameterMap="parameterMap">
	
		<![CDATA[
			UPDATE TSE_INFO_OR_HD 
		       SET UPDATEDATE = to_char(current_timestamp,'YYYYMMDDHH24MISS')
		         , SALE_TOTALPRICE = #{SALE_TOTALPRICE}
		         , PINT_PAYMENT    = #{PINT_PAYMENT} 
		         , PG_TOTALPRICE   = #{PG_TOTALPRICE}
		         , PG_APRNUM       = #{PG_APRNUM}
		         , ORSTATUS        = 'OR02'
                 , PAYSTATUS       = 'PA02'
                 
		     WHERE ORHDKEY = #{ORHDKEY}
		       AND CTKEY   = #{CTKEY}
		]]>	
	
	</update>	

 	<select id="SelectUserDeliveryInfo" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
			SELECT CTKEY
			     , DLHDKEY
			     , ORHDKEY
			     , DLVSTATUS
			     , DLVMBRNAME
			     , DLVADDRESS
			     , ORADDRESS2
			     , DLVZIPCODE
			     , DLVTEL
			     , ORCOUNTRYCODE
			     , ORSTATE
			     , DLCOMLDATE
			     , DLVFEE
			     , DLVEMAIL
			     , DLVMOBILE
			     , DLREQUESTEDTERM
			  FROM TSE_INFO_DL_HD
			 WHERE ORHDKEY = #{ORHDKEY}
			   AND CTKEY   = #{CTKEY}
 		]]>	 
	</select>
		
</mapper>