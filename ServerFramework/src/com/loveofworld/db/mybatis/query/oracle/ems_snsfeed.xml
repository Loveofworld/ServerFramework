<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd"> 

<mapper namespace="com.vinflux.mobile.ems.snsfeed">
	<parameterMap id="parameterMap" type="java.util.HashMap" />
 	<resultMap id="resultMap" type="java.util.HashMap" />

	<insert id="InsertSNSFeedInfo" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO  TSE_INFO_SRP 
			(
			  CTKEY
			, SCRAPID
			, MYHOMEID
			, SCRAPNAME
			, SCRAPCONTENT
			, IMGID
			, INSERTDATE
			, INSERTURKEY
			, UPDATEDATE
			, UPDATEURKEY
			)
		    VALUES
		    (
		      #{CTKEY}
		    , #{SCRAPID}
		    , #{MBRBARCODE}
		    , #{SCRAPNAME}
		    , #{SCRAPCONTENT}
		    , #{IMGID}
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    , #{MBRBARCODE}
		    )	
		]]>		
	</insert>
	
	
	<select id="SelectSNSFeedInfoList" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[

			SELECT *
			  FROM (
			  SELECT ROWNUM AS ROWNO, C.* 
			    FROM (  -- 제품정보 헤더  
						 SELECT A.CTKEY
							  , A.SCRAPID
							  , A.MYHOMEID
							  , A.SCRAPNAME
							  , A.SCRAPCONTENT
							  , (SELECT C.IMGURL 
							       FROM TSE_INFO_IMG C
							      WHERE C.FILEID = A.IMGID) AS FEEDIMGPATH
							  , A.INSERTDATE
							  , A.UPDATEDATE
							  , B.MBRBARCODE
							  ,	B.EMAIL
							  , B.NICKNAME
							  , (SELECT C.IMGURL 
							       FROM TSE_INFO_IMG C
							      WHERE C.FILEID = B.IMGID) AS PROFILEIMGPATH	
		      				  , (SELECT COUNT(D.SCRAPID) 
								   FROM TSE_INFO_LI  D
								  WHERE D.SCRAPID   = A.SCRAPID
								    AND D.MYHOMEID  = #{MBRBARCODE}
								    AND D.ISDISPLAY = 'Y'
								 ) AS ISLIKE 
 		      				  , (SELECT COUNT(D.SCRAPID) 
								   FROM TSE_INFO_LI  D
								  WHERE D.SCRAPID   = A.SCRAPID
								    AND D.ISDISPLAY = 'Y'
								 ) AS LIKECOUNT
 		      				  , (SELECT COUNT(D.SCRAPID) 
								   FROM TSE_INFO_SRPCO  D
								  WHERE D.SCRAPID  = A.SCRAPID
								    AND D.ISDELETE = 'N'
								 ) AS COMMENTCOUNT
							  ,  NVL(A.VIEWCNT, '0') AS VIEWCOUNT
			 ]]>
			 
		 		<choose>
				    <when test='SEARCHINFO.TYPE == "MY"'>
	 			 		<![CDATA[
						   FROM TSE_INFO_SRP A
						      , TSE_MST_MEM  B
						  WHERE A.MYHOMEID = B.MBRBARCODE
							AND A.MYHOMEID = #{SEARCHINFO.MBRBARCODE}
						]]>	
				   </when>
				   <when test='SEARCHINFO.TYPE == "LIKE"'>
						<![CDATA[
                           FROM TSE_INFO_SRP A
						      , TSE_MST_MEM  B
						      , TSE_INFO_LI  C
						  WHERE A.MYHOMEID = B.MBRBARCODE
						    AND A.SCRAPID  = C.SCRAPID
							AND C.MYHOMEID = #{SEARCHINFO.MBRBARCODE}
						]]>
				   </when>
				   <otherwise>
						<![CDATA[
						   FROM TSE_INFO_SRP A
						      , TSE_MST_MEM  B
						  WHERE A.MYHOMEID = B.MBRBARCODE
						]]>
				   </otherwise>
			   </choose>
			 <![CDATA[
			 		       AND A.CTKEY   = #{CTKEY}
			 			   AND A.ISDISPLAY = 'Y'
						 ORDER BY A.INSERTDATE DESC
 			         ) C
			   WHERE ROWNUM <= #{LAST_INDEX}
			   ORDER BY ROWNUM ASC
			   ) D
			 WHERE D.ROWNO >= #{START_INDEX}  
 		]]>	 
	</select>
	
	
	<select id="SelectSNSFeedInfo" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[

			 SELECT A.CTKEY
				  , A.SCRAPID
				  , A.MYHOMEID
				  , A.SCRAPNAME
				  , A.SCRAPCONTENT
				  , (SELECT C.IMGURL 
				       FROM TSE_INFO_IMG C
				      WHERE C.FILEID = A.IMGID) AS FEEDIMGPATH
				  , A.INSERTDATE
				  , A.UPDATEDATE
				  , B.MBRBARCODE
				  ,	B.EMAIL
				  , B.NICKNAME
				  , (SELECT C.IMGURL 
				       FROM TSE_INFO_IMG C
				      WHERE C.FILEID = B.IMGID) AS PROFILEIMGPATH	
			      , (SELECT COUNT(D.SCRAPID) 
							   FROM TSE_INFO_LI  D
							  WHERE D.SCRAPID   = A.SCRAPID
							    AND D.MYHOMEID  = #{MBRBARCODE}
							    AND D.ISDISPLAY = 'Y'
							 ) AS ISLIKE 
   				  , (SELECT COUNT(D.SCRAPID) 
					   FROM TSE_INFO_LI  D
					  WHERE D.SCRAPID   = A.SCRAPID
					    AND D.ISDISPLAY = 'Y'
					 ) AS LIKECOUNT
  				  , (SELECT COUNT(D.SCRAPID) 
					   FROM TSE_INFO_SRPCO  D
					  WHERE D.SCRAPID  = A.SCRAPID
					    AND D.ISDELETE = 'N'
					 ) AS COMMENTCOUNT
				  ,  NVL(VIEWCNT, '0') AS VIEWCOUNT
			  FROM TSE_INFO_SRP A
			     , TSE_MST_MEM  B
			 WHERE A.MYHOMEID = B.MBRBARCODE
 		]]>
 
		<if test="MBRBARCODE != null and SCRAPID == null">
			<![CDATA[
				AND A.MYHOMEID = #{MBRBARCODE}
			]]>	
		</if>
		
		<if test="MBRBARCODE != null and SCRAPID != null">
			<![CDATA[
				AND A.MYHOMEID = #{MBRBARCODE}
				AND A.SCRAPID  = #{SCRAPID}
			]]>	
		</if>
	
 		<![CDATA[
 	            AND A.CTKEY   = #{CTKEY}
 			    AND A.ISDISPLAY = 'Y'
			  ORDER BY A.INSERTDATE DESC
 		]]>
 			 
	</select>
	
	
	<insert id="InsertSNSFeedProductInfoInfo" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO  TSE_INFO_SRPIC 
			(
			  CTKEY
			, SCRAPID
			, RPRICKEY
			, INSERTDATE
			, INSERTURKEY
			, UPDATEDATE
			, UPDATEURKEY
			)
		    VALUES
		    (
		      #{CTKEY}
		    , #{SCRAPID}
		    , #{RPRICKEY}
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
			, #{MBRBARCODE}
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
	        , #{MBRBARCODE}
		    )	
		]]>		
	</insert>
	
	
	<delete id="DeleteSNSFeedInfo" parameterMap="parameterMap">
		<![CDATA[	
			DELETE FROM TSE_INFO_SRP 
  		     WHERE SCRAPID = #{SCRAPID}
	           AND CTKEY   = #{CTKEY}
 		]]>	 
	</delete>
	
	
	
	<update id="UpdateSNSFeedInfo" parameterMap="parameterMap">
		
		<![CDATA[
			UPDATE TSE_INFO_SRP
		]]>	
		<if test="ISDISPLAY != null">
			<![CDATA[
			   SET ISDISPLAY = #{ISDISPLAY}
		     WHERE MYHOMEID  = #{MBRBARCODE}
			   AND SCRAPID   = #{SCRAPID}
		       AND CTKEY   = #{CTKEY} 
	 		]]>	
		
		</if>
	</update>	
	
		
	<update id="UpdateSNSFeedViewCount" parameterMap="parameterMap">
		
		<![CDATA[
			UPDATE TSE_INFO_SRP
			   SET VIEWCNT = NVL(VIEWCNT, 0) + 1
		     WHERE SCRAPID   = #{SCRAPID}
		       AND CTKEY   = #{CTKEY}
		]]>	
	</update>	
	
	
	
	
	<delete id="DeleteSNSFeedProductInfoInfo" parameterMap="parameterMap">
		<![CDATA[	
			DELETE FROM TSE_INFO_SRPIC 
			 WHERE SCRAPID = #{SCRAPID}
			   AND CTKEY   = #{CTKEY}
 		]]>	 
	</delete>
	
	
	
	<insert id="InsertLikeSNSFeed" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO TSE_INFO_LI 
			(
			  CTKEY
			, SCRAPID
			, LIKEID
			, MYHOMEID
			, ISDISPLAY
			, INSERTDATE
			, UPDATEDATE
			)
		    VALUES
		    (
		      #{CTKEY}
		    , #{SCRAPID}
		    , #{SCRAPID}
		    , #{MBRBARCODE}
		    , 'Y'
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    )	
		]]>		
	</insert>
	
	
	<update id="UpdateLikeSNSFeed" parameterMap="parameterMap">
		
		<![CDATA[
			UPDATE TSE_INFO_LI
			   SET ISDISPLAY  = 'N'
			     , UPDATEDATE = to_char(current_timestamp,'YYYYMMDDHH24MISS')
		     WHERE MYHOMEID = #{MBRBARCODE}
			   AND SCRAPID  = #{SCRAPID}
	           AND CTKEY   = #{CTKEY}
		]]>	
	
	</update>	
	
	<update id="DeleteLikeSNSFeed" parameterMap="parameterMap">
		
		<![CDATA[
			DELETE FROM TSE_INFO_LI
		     WHERE MYHOMEID = #{MBRBARCODE}
			   AND SCRAPID  = #{SCRAPID}
               AND CTKEY   = #{CTKEY} 			   
		]]>	
	
	</update>	




	<select id="SelectSNSCommentList" parameterMap="parameterMap" resultMap="resultMap">
		<![CDATA[
			SELECT A.COMMENTID
				 , A.SCRAPID
			     , A.CONTENT
			     , A.INSERTDATE
			     , B.NICKNAME
			     , B.MBRBARCODE
			     , NVL(C.IMGURL, 'NONE') AS IMGPATH
			  FROM TSE_INFO_SRPCO A
			     , TSE_MST_MEM    B
			     , TSE_INFO_IMG   C
			 WHERE A.MEMBARCODE = B.MBRBARCODE
			   AND C.FILEID     = B.IMGID
			   AND A.ISDELETE   = 'N'
			   AND A.SCRAPID    = #{SCRAPID}
               AND A.CTKEY      = #{CTKEY}			   
			 ORDER BY A.INSERTDATE DESC
		]]>		
	</select>
	
	
							      
	
	
	<insert id="InsertSNSCommentList" parameterMap="parameterMap">
		<![CDATA[
			INSERT INTO TSE_INFO_SRPCO 
			(
			  CTKEY
			, SCRAPID
			, COMMENTID
			, MEMBARCODE
			, CONTENT
			, ISDELETE
			, INSERTDATE
			, UPDATEDATE
			)
		    VALUES
		    (
		      #{CTKEY}
		    , #{SCRAPID}
		    , #{COMMENTID}
		    , #{MBRBARCODE}
		    , #{CONTENT}
		    , 'N'
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    , to_char(current_timestamp,'YYYYMMDDHH24MISS')
		    )	
		]]>		
	</insert>
	
		
	<update id="UpdateSNSCommentList" parameterMap="parameterMap">
		
		<![CDATA[
			UPDATE TSE_INFO_SRPCO
			   SET ISDELETE  = 'Y'
			     , UPDATEDATE = to_char(current_timestamp,'YYYYMMDDHH24MISS')
			     , DELETEDATE = to_char(current_timestamp,'YYYYMMDDHH24MISS')
		     WHERE MEMBARCODE = #{MBRBARCODE}
			   AND SCRAPID    = #{SCRAPID}
    	       AND CTKEY   = #{CTKEY}
			   AND COMMENTID  = #{COMMENTID}
		]]>	
	
	</update>	
	



</mapper>